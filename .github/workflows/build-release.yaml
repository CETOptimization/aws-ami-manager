name: Build Release

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          cache: 'true'

      - name: Cross Platform Build
        id: cross-platform-build
        shell: bash
        run: |
          set -euo pipefail
          NAME="aws-ami-manager"
          DIST_FOLDER="dist"
          TAG="${{ inputs.tag_name }}"
          mkdir -p $DIST_FOLDER
          
          build() {
            local goos="$1" goarch="$2" ext="$3"
            local out="${DIST_FOLDER}/${NAME}_${TAG}_${goos}_${goarch}${ext}"
            echo "Building $out"
            CGO_ENABLED=0 GOOS="$goos" GOARCH="$goarch" go build -ldflags="-s -w" -o "$out" .
          }
          
          build linux amd64 ""
          build linux arm64 ""
          build darwin amd64 ""
          build darwin arm64 ""
          build windows amd64 ".exe"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag_name }}
          files: |
            dist/*
